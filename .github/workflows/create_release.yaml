on:
  push:
    tags:
    - "v*"
  release:
    types: [published]

name: Create and push released image

jobs:
  build-and-push-image:
    if: (github.repository == 'kubevirt/csi-driver')
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: build image
      shell: bash
      env:
        QUAY_TOKEN: ${{secrets.QUAY_TOKEN}}
        REGISTRY: "quay.io/kubevirt"
        TARGET_NAME: "kubevirt-csi-driver"
        TAG: ${{ github.ref_name }}
      run: |
        echo $QUAY_TOKEN | docker login -u="kubevirt+csidriver" quay.io --password-stdin
        make image-build
        make image-push
